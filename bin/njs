#!/usr/bin/env node

const _ = require('lodash')
const Path = require('path')
const nunjucks = require('nunjucks')

function loadContext (file) {
  try {
    return require(file)
  } catch (e) {
    return null
  }
}

function joinURI (base, path) {
  return base.replace(/\/+$/, '') + '/' + path.replace(/^\/+/, '')
}

const nodeEnv = process.env.NODE_ENV || 'development'
const cwd = process.cwd()
const tplFile = process.argv[2]
const context = _(process.argv)
  .slice(3)
  .map((file) => Path.resolve(cwd, file))
  .uniq()
  .map(loadContext)
  .filter()
  .reduce((ctx, data) => _.merge({}, ctx, data), {})

context.env = nodeEnv
context.uri = (path) => joinURI(context.baseURL || '', path)
context.s = (path) => joinURI(context.staticURL || '', path)

nunjucks.render(tplFile, context, function (err, html) {
  if (err) {
    console.error(err)
  } else {
    process.stdout.write(html)
  }
})
